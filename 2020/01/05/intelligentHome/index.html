<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>【Zigbee和STM32】智能家居系统 | Stefan&#39;s Blog</title>
  
  <meta name="keywords" content="Life,Learn.">
  
  
  <meta name="description" content="Record learning tutorials and life insights.">
  

  

  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.6.3/css/all.min.css">
  

  
  <link rel="shortcut icon" type="image/x-icon" href="https://cdn.jsdelivr.net/gh/xaoxuu/assets@master/favicon/favicon.ico">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.5/css/style.css">
  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <h1 class='title'>Stefan's Blog</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-rss fa-fw'></i>&nbsp;博文
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/projects/"
            
            
            id="projects">
            <i class='fas fa-code-branch fa-fw'></i>&nbsp;项目
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/friends/"
            
              rel="nofollow"
            
            
            id="friends">
            <i class='fas fa-link fa-fw'></i>&nbsp;友链
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header pure">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="pure"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          Stefan's Blog
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-grin fa-fw'></i>&nbsp;示例
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blog/categories/"
                  
                    rel="nofollow"
                  
                  
                  id="blogcategories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blog/tags/"
                  
                    rel="nofollow"
                  
                  
                  id="blogtags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blog/archives/"
                  
                    rel="nofollow"
                  
                  
                  id="blogarchives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜索" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blog/archives/"
                
                  rel="nofollow"
                
                
                id="blogarchives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/friends/"
                
                  rel="nofollow"
                
                
                id="friends">
								<i class='fas fa-link fa-fw'></i>&nbsp;我的友链
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="https://github.com/Stefancharles"
                
                  rel="nofollow"
                
                
                id="https:github.comStefancharles">
								<i class='fas fa-book fa-fw'></i>&nbsp;主题文档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  
    <article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2020/01/05/intelligentHome/">
        【Zigbee和STM32】智能家居系统
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://Stefancharles.xyz" rel="nofollow">
      
        <img src="https://i.loli.net/2019/08/15/4zEt9A6LvBegWX8.jpg">
      
      <p>Stefan</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-01-06T15:14:17+08:00">
  <a class='notlink'>
    <i class="fas fa-clock" aria-hidden="true"></i>
    <p>最后更新于 2020年1月6日</p>
  </a>
</div>

          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          <h1 id="基于Zigbee和STM32的智能家居系统"><a href="#基于Zigbee和STM32的智能家居系统" class="headerlink" title="基于Zigbee和STM32的智能家居系统"></a>基于Zigbee和STM32的智能家居系统</h1><p>新的一年开始了，这个学期也差不多告一段落了，近段时间一直忙于做课程设计。空闲的时间相对于前几个星期来说有很多。毕竟一年结束了，本来在脑海了构想了很多话，想做一个关于过去一年里总结的博客， 但是这几天工作效率出奇的低，一直没能开始动手。现在先对Zigbee课程设计做一个总结当作热身吧。</p>
<hr>
<blockquote>
<p>Part of the journey is the end. ——Tony Stark</p>
</blockquote>
<hr>
<blockquote>
<p>结束亦是旅途的一部分。——Tony Stark</p>
</blockquote>
<hr>
<a id="more"></a>


<h2 id="设计方案概述"><a href="#设计方案概述" class="headerlink" title="设计方案概述"></a>设计方案概述</h2><p><img src="https://i.loli.net/2020/01/05/xWCUSgyoGIcALqB.png" alt="image.png"></p>
<p>​    终端节点开发板采集温度等数据后发给协调器，协调器通过串口与STM32开发板相连接，STM32通过串口发给电脑。电脑使用我们自己开发的C#串口程序接收数据，将结果显示在电脑上。另一方面我们打算尝试开发板连接STM32端，将数据也发给STM32，STM32接ESP8266WiFi模块后发送数据至云平台，然后使用自己开发的手机端app接收云平台传来的数据，并上发数据给云平台，云平台将手机端的控制指令下发给32端，32端控制开发板亮灯或其他操作。</p>
<hr>
<h2 id="DHT11采集温度"><a href="#DHT11采集温度" class="headerlink" title="DHT11采集温度"></a>DHT11采集温度</h2><p>​    在之前的实验中，当我使用<strong>DHT11</strong>在<strong>协议栈</strong>下总是无法正常采集温度，原因是DHT11需要有严格的时序，需要延时精确的10微秒等时间。而协议栈下会有很多事件打断定时器，从而无法产生精确的时间。</p>
<p>​    这一次，我询问了一些高手，终于发现了解决问题的关键。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Delay_us</span><span class="params">()</span> <span class="comment">//1 us延时</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MicroWait(<span class="number">1</span>);</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Delay_10us</span><span class="params">()</span> <span class="comment">//10 us延时</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MicroWait(<span class="number">10</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Delay_ms</span><span class="params">(uint Time)</span><span class="comment">//n ms延时</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> i;</span><br><span class="line">  <span class="keyword">while</span>(Time--)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">      Delay_10us();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    没错，这里用的不是定时器计时，而是用的一个叫MicroWait(10)的函数。我们进这个函数看。发现这个函数事实上是另一个Onboard_wait(t)函数。这个函数是由开发板本身提供的onboard函数。这样一来就可以使用DHT11采集温湿度了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MicroWait(t) Onboard_wait(t)</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="终端节点"><a href="#终端节点" class="headerlink" title="终端节点"></a>终端节点</h2><p>终端节点要做的就两件事情，一个是采集温度然后发送给协调器，另一个事情就是接收来自协调器的控制命令并执行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GenericApp_SendTheMessage</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    DHT11();   <span class="comment">//温度采集 </span></span><br><span class="line">    HalLedSet(HAL_LED_1,HAL_LED_MODE_ON);</span><br><span class="line">    uint8 Temp[<span class="number">2</span>];</span><br><span class="line">    Temp[<span class="number">0</span>] = wendu_shi+<span class="number">0x30</span>;</span><br><span class="line">    Temp[<span class="number">1</span>] = wendu_ge+<span class="number">0x30</span>;</span><br><span class="line">    uint8 humidity[<span class="number">2</span>];</span><br><span class="line">    humidity[<span class="number">0</span>] = shidu_shi+<span class="number">0x30</span>;</span><br><span class="line">    humidity[<span class="number">1</span>] = shidu_ge+<span class="number">0x30</span>;</span><br><span class="line">    <span class="comment">/*******串口打印*********/</span></span><br><span class="line">    HalUARTWrite(<span class="number">0</span>,<span class="string">"Temp:"</span>,<span class="number">5</span>);</span><br><span class="line">    HalUARTWrite(<span class="number">0</span>,Temp,<span class="number">2</span>);</span><br><span class="line">    HalUARTWrite(<span class="number">0</span>,<span class="string">"  Hum:"</span>,<span class="number">6</span>);</span><br><span class="line">    HalUARTWrite(<span class="number">0</span>,humidity,<span class="number">2</span>);</span><br><span class="line">    HalLedSet(HAL_LED_1,HAL_LED_MODE_OFF);</span><br><span class="line">     AF_DataRequest( &amp;GenericApp_DstAddr, &amp;GenericApp_epDesc,</span><br><span class="line">                       GENERICAPP_CLUSTERID,</span><br><span class="line">                       <span class="number">2</span>,</span><br><span class="line">                       humidity,</span><br><span class="line">                       &amp;GenericApp_TransID,</span><br><span class="line">                       AF_DISCV_ROUTE, </span><br><span class="line">                       AF_DEFAULT_RADIUS ) ;</span><br><span class="line">     </span><br><span class="line">     AF_DataRequest( &amp;GenericApp_DstAddr, &amp;GenericApp_epDesc,</span><br><span class="line">                       GENERICAPP_TEMPCLUSTER,</span><br><span class="line">                       <span class="number">2</span>,</span><br><span class="line">                       Temp,</span><br><span class="line">                       &amp;GenericApp_TransID,</span><br><span class="line">                       AF_DISCV_ROUTE, </span><br><span class="line">                       AF_DEFAULT_RADIUS ) ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在终端节点加入协调器的网络后，进入面的GenericApp_SendTheMessage()函数里，在这个函数里调用DHT11()函数采集温度和湿度信息，把温度存到Temp数组里，湿度存到humidity数组里。然后设计两个簇分别将温度和湿度发送给协调器，这样设计的目的是为了方便协调器处理不同数据。</p>
<p>同时，终端节点需要接收来自协调器的控制信息，例如控制LED灯：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GenericApp_MessageMSGCB</span><span class="params">(afIncomingMSGPacket_t *pkt )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">7</span>];</span><br><span class="line">  <span class="keyword">switch</span>(pkt-&gt;clusterId)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> (GENERICAPP_CLUSTERID):</span><br><span class="line">    osal_memcpy(buf,pkt -&gt; cmd.Data,<span class="number">7</span>);</span><br><span class="line">     <span class="keyword">if</span>(osal_memcmp(buf,<span class="string">"LED_ON"</span>,<span class="number">7</span>))</span><br><span class="line">     &#123;</span><br><span class="line">      HalLedSet(HAL_LED_2,HAL_LED_MODE_ON); </span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span>(osal_memcmp(buf,<span class="string">"LED_OFF"</span>,<span class="number">7</span>))</span><br><span class="line">     &#123;</span><br><span class="line">      HalLedSet(HAL_LED_2,HAL_LED_MODE_ON);</span><br><span class="line">     &#125;</span><br><span class="line">  <span class="keyword">case</span> GENERICAPP_BROADCAST_CID:</span><br><span class="line">    osal_memcpy(buf,pkt -&gt; cmd.Data,<span class="number">7</span>);</span><br><span class="line">     <span class="keyword">if</span>(osal_memcmp(buf,<span class="string">"LED_ON"</span>,<span class="number">6</span>))</span><br><span class="line">     &#123;</span><br><span class="line">      HalLedSet(HAL_LED_2,HAL_LED_MODE_ON); </span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span>(osal_memcmp(buf,<span class="string">"LED_OFF"</span>,<span class="number">7</span>))</span><br><span class="line">     &#123;</span><br><span class="line">      HalLedSet(HAL_LED_2,HAL_LED_MODE_OFF);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="协调器"><a href="#协调器" class="headerlink" title="协调器"></a>协调器</h2><p>协调器收到来自终端节点的消息时，需要将数据交给32端。这里使用的是串口进行通信。也就是分簇进行消息处理，然后写到串口。这样温湿度数据就被交给32端了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GenericApp_MessageMSGCB</span><span class="params">( afIncomingMSGPacket_t *pkt )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> ( pkt-&gt;clusterId )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> GENERICAPP_CLUSTERID: </span><br><span class="line">      HalLedSet(HAL_LED_1,HAL_LED_MODE_ON);</span><br><span class="line">      osal_memcpy(humid, pkt-&gt;cmd.Data, <span class="number">2</span>);</span><br><span class="line">      HalUARTWrite(<span class="number">0</span>, humid, <span class="number">2</span>);</span><br><span class="line">      HalUARTWrite(<span class="number">0</span>, tmp, <span class="number">2</span>);</span><br><span class="line">      Delay_ms(<span class="number">500</span>);</span><br><span class="line">      HalLedSet(HAL_LED_1,HAL_LED_MODE_OFF);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> GENERICAPP_TEMPCLUSTER: </span><br><span class="line">      HalLedSet(HAL_LED_1,HAL_LED_MODE_ON);</span><br><span class="line">      HalUARTWrite(<span class="number">0</span>, humid, <span class="number">2</span>);</span><br><span class="line">      osal_memcpy(tmp, pkt-&gt;cmd.Data, <span class="number">2</span>);</span><br><span class="line">      HalUARTWrite(<span class="number">0</span>, tmp, <span class="number">2</span>);</span><br><span class="line">      HalUARTWrite(<span class="number">0</span>,<span class="string">" \n"</span>,osal_strlen(<span class="string">" \n"</span>));</span><br><span class="line">      Delay_ms(<span class="number">500</span>);</span><br><span class="line">      HalLedSet(HAL_LED_1,HAL_LED_MODE_OFF);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时从串口接到32端发来的控制信息时，需要转发给终端节点，巧妙的地方在于，因为使用的是串口通信，这里就使用串口回调函数，关键代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rxCB</span><span class="params">(uint8 port, uint8 event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  osal_memset(uartbuf, <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">  HalUARTRead(<span class="number">0</span>, uartbuf, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> (osal_memcmp(uartbuf, <span class="string">"LED_ON"</span>, <span class="number">6</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    AF_DataRequest(&amp;GenericApp_DstAddr, &amp;GenericApp_epDesc,</span><br><span class="line">                   GENERICAPP_BROADCAST_CID,</span><br><span class="line">                   (byte)osal_strlen(uartbuf) + <span class="number">1</span>,</span><br><span class="line">                   (byte *)&amp;uartbuf,</span><br><span class="line">                   &amp;GenericApp_TransID,</span><br><span class="line">                   AF_DISCV_ROUTE, AF_DEFAULT_RADIUS);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (osal_memcmp(uartbuf, <span class="string">"LED_OFF"</span>, <span class="number">7</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    AF_DataRequest(&amp;GenericApp_DstAddr, &amp;GenericApp_epDesc,</span><br><span class="line">                   GENERICAPP_BROADCAST_CID,</span><br><span class="line">                   (byte)osal_strlen(uartbuf) + <span class="number">1</span>,</span><br><span class="line">                   (byte *)&amp;uartbuf,</span><br><span class="line">                   &amp;GenericApp_TransID,</span><br><span class="line">                   AF_DISCV_ROUTE, AF_DEFAULT_RADIUS);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="STM32端"><a href="#STM32端" class="headerlink" title="STM32端"></a>STM32端</h2><p>STM32端首先初始化中断分组，串口2，3。进行时钟初始化等，关键代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NVIC_Priority_Group_Configuration();  </span><br><span class="line">SYSTICK_init();    </span><br><span class="line">uart_init(<span class="number">115200</span>);  </span><br><span class="line">delay_init();  </span><br><span class="line">LCD_Init();  </span><br><span class="line">rtc_init(<span class="literal">NULL</span>);  </span><br><span class="line">USART3_Init(<span class="number">115200</span>);  </span><br><span class="line">USART2_Init(<span class="number">115200</span>);</span><br></pre></td></tr></table></figure>

<p>然后就是与云平台通信，事实上，ESP8266是通过串口和STM32进行通信。所以上面初始化的两个串口，一个是用于与协调器通信，另一个是用于ESP8266。与云平台通信的核心代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cloud_task</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *temp = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int8_t</span> tempint=<span class="number">0</span>,humidint=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">uint32_t</span> lastTime;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int8_t</span> erroCount=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int8_t</span> error=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">50</span>];</span><br><span class="line">    <span class="keyword">if</span>(F_AT_RX_FINISH)</span><br><span class="line">	 &#123;	 </span><br><span class="line">		 <span class="built_in">printf</span>(AT_RX_BUF);</span><br><span class="line">		 USER_DataAnalysisProcess((<span class="keyword">char</span> *)AT_RX_BUF);</span><br><span class="line">		 <span class="built_in">memset</span>(IpData, <span class="number">0x00</span>, <span class="number">128</span>);</span><br><span class="line">		 ClrAtRxBuf();</span><br><span class="line">	 &#125;</span><br><span class="line">	 <span class="keyword">if</span>((<span class="keyword">uint32_t</span>)(SYSTICK_get_time()-lastTime&gt;=<span class="number">500</span>)&amp;&amp;(<span class="keyword">uint32_t</span>)(SYSTICK_get_time()-lastTime&lt;=<span class="number">501</span>))</span><br><span class="line">	 &#123;</span><br><span class="line">	  	  RTC_Get();</span><br><span class="line">		  tmp[<span class="number">0</span>]=USART2_RX_BUF[<span class="number">2</span>];</span><br><span class="line">		  tmp[<span class="number">1</span>]=USART2_RX_BUF[<span class="number">3</span>];</span><br><span class="line">		  tmp[<span class="number">2</span>]=<span class="string">'\0'</span>;</span><br><span class="line">		  <span class="built_in">sscanf</span>(tmp, <span class="string">"%d"</span>, &amp;tempint);</span><br><span class="line">		  humid[<span class="number">0</span>]=USART2_RX_BUF[<span class="number">0</span>];</span><br><span class="line">		  humid[<span class="number">1</span>]=USART2_RX_BUF[<span class="number">1</span>];</span><br><span class="line">		  humid[<span class="number">2</span>]=<span class="string">'\0'</span>;</span><br><span class="line">		  <span class="built_in">sscanf</span>(humid, <span class="string">"%d"</span>, &amp;humidint);</span><br><span class="line">		  USART2_RX_STA=<span class="number">0</span>;</span><br><span class="line">	  	<span class="built_in">sprintf</span>(str,<span class="string">"%d-%d-%d %d:%d:%d"</span>,calendar.w_year,calendar.w_month,calendar.w_date,calendar.hour,calendar.min,calendar.sec);</span><br><span class="line">			<span class="keyword">if</span>(tempint!=<span class="number">0</span>)</span><br><span class="line">			error=SE_SendSensor((<span class="keyword">char</span> *)<span class="string">"temperature"</span>, tempint, (<span class="keyword">char</span> *)str);</span><br><span class="line">	 	  ClrAtRxBuf();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>((<span class="keyword">uint32_t</span>)(SYSTICK_get_time()-lastTime&gt;=<span class="number">1000</span>))</span><br><span class="line">	 &#123;</span><br><span class="line">	    lastTime=SYSTICK_get_time();</span><br><span class="line">	  	RTC_Get();				</span><br><span class="line">		  tmp[<span class="number">0</span>]=USART2_RX_BUF[<span class="number">2</span>];</span><br><span class="line">		  tmp[<span class="number">1</span>]=USART2_RX_BUF[<span class="number">3</span>];</span><br><span class="line">		  <span class="built_in">sscanf</span>(tmp, <span class="string">"%d"</span>, &amp;tempint);</span><br><span class="line">		  humid[<span class="number">0</span>]=USART2_RX_BUF[<span class="number">0</span>];</span><br><span class="line">		  humid[<span class="number">1</span>]=USART2_RX_BUF[<span class="number">1</span>];</span><br><span class="line">		  <span class="built_in">sscanf</span>(humid, <span class="string">"%d"</span>, &amp;humidint);</span><br><span class="line">		  USART2_RX_STA=<span class="number">0</span>;		 </span><br><span class="line">	  	<span class="built_in">sprintf</span>(str,<span class="string">"%d-%d-%d %d:%d:%d"</span>,calendar.w_year,calendar.w_month,calendar.w_date,calendar.hour,calendar.min,calendar.sec);</span><br><span class="line">			<span class="keyword">if</span>(humidint!=<span class="number">0</span>)</span><br><span class="line">			error=SE_SendSensor((<span class="keyword">char</span> *)<span class="string">"humidity"</span>, humidint, (<span class="keyword">char</span> *)str);</span><br><span class="line">	 	  ClrAtRxBuf();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的函数是不断轮询F_AT_RX_FINISH，如果有内容就对内容进行解析。</p>
<p>一方面是USER_DataAnalysisProcess函数用于解析云平台发来的控制信息。另一方面，就是调用SE_SendSensor函数把采集到的数据进行上传到云平台。</p>
<p>解析开关灯，其实是解析一种json格式的数据，关键代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USER_DataAnalysisProcess</span><span class="params">(<span class="keyword">char</span> *RxBuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *cmdid = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">uint8_t</span> TxetBuf[<span class="number">128</span>];</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)RxBuf, (<span class="keyword">const</span> <span class="keyword">char</span> *)PING_REQ) != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(ESP8266_IpSend((<span class="keyword">char</span> *)PING_RSP, <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)PING_RSP)) &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			DBG_B_INFO(<span class="string">"心跳包失败\r\n"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			DBG_B_INFO(<span class="string">"心跳包\r\n"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)RxBuf, (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="string">"\"t\":5"</span>) != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)RxBuf, (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="string">"\"apitag\":\"bool_work\""</span>) != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">memset</span>(TxetBuf,<span class="number">0x00</span>,<span class="number">128</span>);</span><br><span class="line">			<span class="keyword">if</span>((<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)RxBuf, (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="string">"\"data\":1"</span>) != <span class="literal">NULL</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				DBG_B_INFO(<span class="string">"开灯"</span>);</span><br><span class="line">			  u2_printf(<span class="string">"LED_ON"</span>);</span><br><span class="line">				cmdid = USER_GetJsonValue((<span class="keyword">char</span> *)RxBuf, (<span class="keyword">char</span> *)<span class="string">"cmdid"</span>);</span><br><span class="line">				<span class="built_in">sprintf</span>((<span class="keyword">char</span> *)TxetBuf,<span class="string">"&#123;\"t\":6,\"cmdid\":%s,\"status\":0,\"data\":1&#125;"</span>,cmdid);</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span>(ESP8266_IpSend((<span class="keyword">char</span> *)TxetBuf, <span class="built_in">strlen</span>((<span class="keyword">char</span> *)TxetBuf)) &lt; <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					DBG_B_INFO(<span class="string">"发送响应失败"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>((<span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)RxBuf, (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="string">"\"data\":0"</span>) != <span class="literal">NULL</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				DBG_B_INFO(<span class="string">"关灯"</span>);</span><br><span class="line">			  u2_printf(<span class="string">"LED_OFF"</span>);</span><br><span class="line">				cmdid = USER_GetJsonValue((<span class="keyword">char</span> *)RxBuf, (<span class="keyword">char</span> *)<span class="string">"cmdid"</span>);</span><br><span class="line">				<span class="built_in">sprintf</span>((<span class="keyword">char</span> *)TxetBuf,<span class="string">"&#123;\"t\":6,\"cmdid\":%s,\"status\":0,\"data\":0&#125;"</span>,cmdid);</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span>(ESP8266_IpSend((<span class="keyword">char</span> *)TxetBuf, <span class="built_in">strlen</span>((<span class="keyword">char</span> *)TxetBuf)) &lt; <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					DBG_B_INFO(<span class="string">"发送响应失败"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然这部分的代码可以进行拓展，例如说可以加入控制继电器等等。稍加改动即可。值得注意的是这里需要事先设置好云平台那边的apitag，apitag一定要一致才可正常收发数据。安卓端也是同理。</p>
<p>32端除了与云平台进行通信，还要动态刷新LCD显示屏。这部分关键代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LCD_ShowString(<span class="number">30</span>,<span class="number">60</span>,<span class="number">200</span>,<span class="number">16</span>,<span class="number">16</span>,<span class="string">"Temperature:"</span>);     </span><br><span class="line">LCD_ShowString(<span class="number">130</span>,<span class="number">60</span>,<span class="number">200</span>,<span class="number">16</span>,<span class="number">16</span>,tmp);   </span><br><span class="line">LCD_ShowString(<span class="number">30</span>,<span class="number">100</span>,<span class="number">200</span>,<span class="number">16</span>,<span class="number">16</span>,<span class="string">"Humidity:"</span>);</span><br><span class="line">LCD_ShowString(<span class="number">120</span>,<span class="number">100</span>,<span class="number">200</span>,<span class="number">16</span>,<span class="number">16</span>,humid);</span><br><span class="line">LCD_ShowString(<span class="number">30</span>,<span class="number">280</span>,<span class="number">200</span>,<span class="number">16</span>,<span class="number">16</span>,<span class="string">"(c) Security Plus Inc."</span>);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="安卓端"><a href="#安卓端" class="headerlink" title="安卓端"></a>安卓端</h2><p>安卓端这边的设计一时半会也讲不清，这里先假设你有一定的云平台开发经验。下面链接是我之前暑假期间写的，可以先去看看。</p>
<p>传送门：<a href="https://stefancharles.xyz/2019/09/04/Android_Code_newland_one/">新大陆安卓端笔记(一)</a></p>
<p>我这里就主要写下关键的部分。安卓端主要使用新大陆的SDK进行通信。可以显示温度和湿度信息到仪表盘上，并且可以控制灯和风扇等。</p>
<p>关键的获取温度代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getTemperature</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">	    netWorkBusiness.getSensor(deviceID, <span class="string">"temperature"</span>, <span class="keyword">new</span> NCallBack&lt;BaseResponseEntity&lt;SensorInfo&gt;&gt;() &#123;  </span><br><span class="line">	        <span class="meta">@Override</span>  </span><br><span class="line">	        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(<span class="keyword">final</span> Call&lt;BaseResponseEntity&lt;SensorInfo&gt;&gt; call, <span class="keyword">final</span> Response&lt;BaseResponseEntity&lt;SensorInfo&gt;&gt; response)</span> </span>&#123;  </span><br><span class="line">	            BaseResponseEntity baseResponseEntity = response.body();  </span><br><span class="line">	            <span class="keyword">if</span> (baseResponseEntity != <span class="keyword">null</span>) &#123;  </span><br><span class="line">	                <span class="keyword">final</span> Gson gson = <span class="keyword">new</span> Gson();  </span><br><span class="line">	                JSONObject jsonObject;  </span><br><span class="line">	                String msg = gson.toJson(baseResponseEntity);  </span><br><span class="line">	                <span class="keyword">try</span> &#123;  </span><br><span class="line">	                    jsonObject = <span class="keyword">new</span> JSONObject(msg);   <span class="comment">//解析数据.  </span></span><br><span class="line">                    JSONObject resultObj = (JSONObject) jsonObject.get(<span class="string">"ResultObj"</span>);  </span><br><span class="line">	                    String TempValue = resultObj.getString(<span class="string">"Value"</span>);  </span><br><span class="line">	                    temperature_d = Double.valueOf(TempValue).intValue();  </span><br><span class="line">	                    temperature = (<span class="keyword">int</span>) temperature_d;  </span><br><span class="line">	                    mDeviceTempHum.setTemp(temperature);<span class="comment">//显示温度数据到仪表盘  </span></span><br><span class="line">	                &#125; <span class="keyword">catch</span> (JSONException e) &#123;  </span><br><span class="line">	                    e.printStackTrace();  </span><br><span class="line">	                &#125;  </span><br><span class="line">	            &#125;  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>控制终端节点的关键代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">btn_light.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;  </span><br><span class="line">	    <span class="meta">@Override</span>  </span><br><span class="line">	    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;  </span><br><span class="line">	        <span class="keyword">if</span>(!light_state)&#123;  </span><br><span class="line">	            control(deviceID,<span class="string">"bool_work"</span>,<span class="number">1</span>);  <span class="comment">// 开灯.  </span></span><br><span class="line">	            btn_light.setCompoundDrawablesWithIntrinsicBounds(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, R.drawable.power_on);  </span><br><span class="line">	        &#125;  </span><br><span class="line">	        <span class="keyword">else</span>&#123;  </span><br><span class="line">	            control(deviceID,<span class="string">"bool_work"</span>,<span class="number">0</span>);  <span class="comment">//关灯.  </span></span><br><span class="line">	            btn_light.setCompoundDrawablesWithIntrinsicBounds(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,R.drawable.power_off);  </span><br><span class="line">	        &#125;  </span><br><span class="line">	        light_state = !light_state;  </span><br><span class="line">	    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实现结果"><a href="#实现结果" class="headerlink" title="实现结果"></a>实现结果</h2><h3 id="安卓端-1"><a href="#安卓端-1" class="headerlink" title="安卓端"></a>安卓端</h3><p><img src="https://i.loli.net/2020/01/05/NjdCRkQiU6ZrL7h.png" alt="image.png"></p>
<p>登录界面如上图。登录界面可以左右滑动切换背景。</p>
<p>这里有点意思的是，我使用的账号的调用API的密钥过期了，而我没有重新申请一个。导致我获取温度的时候一直失败，但是诡异的是我可以正常登录进去。我仔细检查了apitag等参数也没有问题，但是问题依然没解决。我以为新大陆那边改了api，于是我进调试模式试图获取一下登录后的用户token，这时回给我的不是token，而是过期提示。我这才发现密钥已经过期，重新申请后就正常获取温度了。</p>
<p><img src="https://i.loli.net/2020/01/05/SI3xKtlJZ6vanLs.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/01/05/Hi89ODCdNRVtyY5.png" alt="image.png"></p>
<p>当密钥过期后不会返回token，我寻思着应该是这里返回的state依然和正常登录一样的，导致安卓端调用登录api时发现返回状态是成功登录，但是没有检查token是否返回数值。</p>
<p><img src="https://i.loli.net/2020/01/05/FZTsP8RBXfyWGlO.png" alt="image.png"></p>
<p>登录成功后，进入主界面，可以看到温度和湿度信息，并通过下面的两个按钮来控制灯和风扇。按钮有两种状态，红色按钮代表关闭，绿色按钮代表开启。点击“查看历史温度”可以查看历史温度或者湿度的曲线图。</p>
<hr>
<h3 id="C-端串口老助手"><a href="#C-端串口老助手" class="headerlink" title="C#端串口老助手"></a>C#端串口老助手</h3><p><img src="https://i.loli.net/2020/01/05/KJLgE3d6PeSvNtM.png" alt="image.png"></p>
<p>这里串口线接到终端节点上，接32端时还是有很多问题，这里待解决。</p>
<hr>
<h2 id="总体概览"><a href="#总体概览" class="headerlink" title="总体概览"></a>总体概览</h2><p><img src="https://i.loli.net/2020/01/05/3B2VpwUR97kn68Y.png" alt="image.png"></p>
<p>总体连接图就是这样的了。这几天实验室空调坏了，实验室温度只有18度。</p>
<p>经过我们小组成员的努力，改进了终端节点LED的响应速度。但是实际上的响应速度还是有点不理想，没有完美。主要原因可能是它使用的轮询的方式接收来自云平台的消息，而不是采用中断方式，这一点可以以后进行改进。</p>
<p>在云平台的网页端也可以看到温湿度变化趋势。</p>
<p><img src="https://i.loli.net/2020/01/05/k84dyCIOaWhvPgt.png" alt="image.png"></p>
<hr>
<h2 id="与本文不搭边的结语"><a href="#与本文不搭边的结语" class="headerlink" title="与本文不搭边的结语"></a>与本文不搭边的结语</h2><p>“Part of the journey is the end”，中文翻译大致是“结束亦是旅途的一部分。”。我个人感觉，如果把这句话翻译成中文倒缺了一点意味。</p>
<p>这句话是出自于电影《复仇者联盟-终局之战》里钢铁侠Stark在进行时空跳跃前给大家留下的全息留言中的一句话。以防这一次他离开就再也回不来而留下的“Last Words”。当我第一次在电影院听到他说这句话的时候，我听出了这句话里面的遗憾和不舍。对他自己而言，他已经有了一个完美的家庭，有一个爱他三千遍的小女儿。为了peter和其他消失的人能够“复活”，他冒着失去他所拥有的人的风险，如果他自己没能回来，那不能陪伴遗憾和不舍自然会有。对我们观众而言，从十年前的《钢铁侠1》开始到如今这个系列最后的完结，感觉就像几年前而已，没想到时间过得这么快，没想到都要面临Iron Man的离开，至少对我来说，我是感觉到深深的不舍和遗憾。</p>
<p>于是我把这句话设成了我的QQ的签名，再也没改过，这一晃差不多一年又过去了。这次考完考试的我又突然想再看一遍《 Endgame》。而这一次当我再看到那句话的时候，我又读到了新的意味，那是一种释然。告别的释然。遗憾和不舍中又带着告别的释然。我想到了什么，但是我又具体形容不出这种感觉。</p>
<p>我的意思是，一年的时间已经告一段落，每个人或多或少have lost something。这是一种结束，我试图让我自己看明白一个道理——结束也是旅途的一部分。我也试图让我自己面对结束的时候，尽力挥手告别就好。</p>

        </div>
        
          


  <section class='meta' id="footer-meta">
    <hr>
    <div class='new-meta-box'>
      
        
          
  
  <div class='new-meta-item category'>
    <a href='/categories/笔记/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>笔记</p>
    </a>
  </div>


        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Zigbee/" rel="nofollow"><i class="fas fa-hashtag" aria-hidden="true"></i>&nbsp;<p>Zigbee</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/STM32/" rel="nofollow"><i class="fas fa-hashtag" aria-hidden="true"></i>&nbsp;<p>STM32</p></a></div>


        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="QQ好友" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=https://Stefancharles.xyz/2020/01/05/intelligentHome/&title=【Zigbee和STM32】智能家居系统 | Stefan's Blog&pics=https://i.loli.net/2019/08/15/4zEt9A6LvBegWX8.jpg&summary=基于Zigbee和STM32的智能家居系统新的一年开始了，这个学期也差不多告一段落了，近段时间一直忙于做课程设计。空闲的时间相对于前几个星期来说有很多。毕竟一年结束了，本来在脑海了构想了很多话，想做一个关于过去一年里总结的博客， 但是这几天工作效率出奇的低，一直没能开始动手。现在先对Zigbee课程设计做一个总结当作热身吧。


Part of the journey is the end. ——Tony Stark



结束亦是旅途的一部分。——Tony Stark

"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="QQ空间" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://Stefancharles.xyz/2020/01/05/intelligentHome/&title=【Zigbee和STM32】智能家居系统 | Stefan's Blog&pics=https://i.loli.net/2019/08/15/4zEt9A6LvBegWX8.jpg&summary=基于Zigbee和STM32的智能家居系统新的一年开始了，这个学期也差不多告一段落了，近段时间一直忙于做课程设计。空闲的时间相对于前几个星期来说有很多。毕竟一年结束了，本来在脑海了构想了很多话，想做一个关于过去一年里总结的博客， 但是这几天工作效率出奇的低，一直没能开始动手。现在先对Zigbee课程设计做一个总结当作热身吧。


Part of the journey is the end. ——Tony Stark



结束亦是旅途的一部分。——Tony Stark

"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="微博" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=https://Stefancharles.xyz/2020/01/05/intelligentHome/&title=【Zigbee和STM32】智能家居系统 | Stefan's Blog&pics=https://i.loli.net/2019/08/15/4zEt9A6LvBegWX8.jpg&summary=基于Zigbee和STM32的智能家居系统新的一年开始了，这个学期也差不多告一段落了，近段时间一直忙于做课程设计。空闲的时间相对于前几个星期来说有很多。毕竟一年结束了，本来在脑海了构想了很多话，想做一个关于过去一年里总结的博客， 但是这几天工作效率出奇的低，一直没能开始动手。现在先对Zigbee课程设计做一个总结当作热身吧。


Part of the journey is the end. ——Tony Stark



结束亦是旅途的一部分。——Tony Stark

"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
            <div class="prev-next">
                
                    <section class="prev">
                        <span class="art-item-left">
                            <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页</h6>
                            <h4>
                                <a href="/2020/01/06/installUbuntu/" rel="prev" title="【Ubuntu】Ubuntu和Win10双系统安装教程">
                                  
                                      【Ubuntu】Ubuntu和Win10双系统安装教程
                                  
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <a class="tag" href="/tags/Ubuntu/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>Ubuntu</a>
                                </h6>
                            
                        </span>
                    </section>
                
                
                    <section class="next">
                        <span class="art-item-right" aria-hidden="true">
                            <h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                            <h4>
                                <a href="/2019/12/28/UartHelper/" rel="prev" title="【C#】串口老助手">
                                    
                                        【C#】串口老助手
                                    
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <a class="tag" href="/tags/C/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>C#</a>
                                </h6>
                            
                        </span>
                    </section>
                
            </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box comments">
    <section class="article typo">
      <h4><i class="fas fa-comments fa-fw" aria-hidden="true"></i>&nbsp;评论</h4>
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-spinner fa-spin fa-fw"></i>
          </div>
        </section>
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: '【Zigbee和STM32】智能家居系统',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
        
          
          
            <section class='widget author'>
  <div class='content pure'>
    
      <div class='avatar'>
        <img class='avatar' src='https://i.loli.net/2019/08/15/oZF8Hh2dKIJ5V1a.jpg'/>
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="/stefancharles@vip.qq.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://github.com/Stefancharles"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://c.y.qq.com/base/fcgi-bin/u?__=jsQmg4H"
              class="social fas fa-headphones-alt flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

          
        
      
        
          
          
            
  <section class='widget toc-wrapper'>
    
<header class='pure'>
  <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;本文目录</div>
  
    <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div>
  
</header>

    <div class='content pure'>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#基于Zigbee和STM32的智能家居系统"><span class="toc-text">基于Zigbee和STM32的智能家居系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#设计方案概述"><span class="toc-text">设计方案概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DHT11采集温度"><span class="toc-text">DHT11采集温度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#终端节点"><span class="toc-text">终端节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#协调器"><span class="toc-text">协调器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#STM32端"><span class="toc-text">STM32端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安卓端"><span class="toc-text">安卓端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现结果"><span class="toc-text">实现结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安卓端-1"><span class="toc-text">安卓端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C-端串口老助手"><span class="toc-text">C#端串口老助手</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总体概览"><span class="toc-text">总体概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#与本文不搭边的结语"><span class="toc-text">与本文不搭边的结语</span></a></li></ol></li></ol>
    </div>
  </section>


          
        
      
        
          
          
            <section class='widget grid'>
  
<header class='pure'>
  <div><i class="fas fa-map-signs fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;站内导航</div>
  
</header>

  <div class='content pure'>
    <ul class="grid navgation">
      
        <li><a class="flat-box" title="/" href="/"
          
          
          id="home">
          
            <i class="fas fa-clock fa-fw" aria-hidden="true"></i>
          
          近期文章
        </a></li>
      
        <li><a class="flat-box" title="/blog/archives/" href="/blog/archives/"
          
            rel="nofollow"
          
          
          id="blogarchives">
          
            <i class="fas fa-archive fa-fw" aria-hidden="true"></i>
          
          文章归档
        </a></li>
      
        <li><a class="flat-box" title="/projects/" href="/projects/"
          
          
          id="projects">
          
            <i class="fas fa-code-branch fa-fw" aria-hidden="true"></i>
          
          开源项目
        </a></li>
      
        <li><a class="flat-box" title="/friends/" href="/friends/"
          
            rel="nofollow"
          
          
          id="friends">
          
            <i class="fas fa-link fa-fw" aria-hidden="true"></i>
          
          我的友链
        </a></li>
      
        <li><a class="flat-box" title="https://github.com/Stefancharles" href="https://github.com/Stefancharles"
          
            rel="nofollow"
          
          
          id="https:github.comStefancharles">
          
            <i class="fas fa-book fa-fw" aria-hidden="true"></i>
          
          主题文档
        </a></li>
      
        <li><a class="flat-box" title="/about/" href="/about/"
          
            rel="nofollow"
          
          
          id="about">
          
            <i class="fas fa-info-circle fa-fw" aria-hidden="true"></i>
          
          关于小站
        </a></li>
      
    </ul>
  </div>
</section>

          
        
      
        
          
          
            
  <section class='widget category'>
    
<header class='pure'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;文章分类</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/categories/"
    title="blog/categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/Android/" href="/categories/Android/"><div class='name'>Android</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/Android/MVP/" href="/categories/Android/MVP/"><div class='name'>MVP</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/Android/OpenCV/" href="/categories/Android/OpenCV/"><div class='name'>OpenCV</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/C/" href="/categories/C/"><div class='name'>C++</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/C/Qt/" href="/categories/C/Qt/"><div class='name'>Qt</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/复习/" href="/categories/复习/"><div class='name'>复习</div><div class='badge'>(4)</div></a></li>
        
          <li><a class="flat-box" title="/categories/教程/" href="/categories/教程/"><div class='name'>教程</div><div class='badge'>(12)</div></a></li>
        
          <li><a class="flat-box" title="/categories/笔记/" href="/categories/笔记/"><div class='name'>笔记</div><div class='badge'>(20)</div></a></li>
        
          <li><a class="flat-box" title="/categories/随笔/" href="/categories/随笔/"><div class='name'>随笔</div><div class='badge'>(3)</div></a></li>
        
      </ul>
    </div>
  </section>


          
        
      
        
          
          
            
  <section class='widget tagcloud'>
    
<header class='pure'>
  <div><i class="fas fa-fire fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;热门标签</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/tags/"
    title="blog/tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <a href="/tags/Android/" style="font-size: 24px; color: #555">Android</a> <a href="/tags/C/" style="font-size: 14px; color: #999">C#</a> <a href="/tags/C/" style="font-size: 14px; color: #999">C++</a> <a href="/tags/CNN/" style="font-size: 14px; color: #999">CNN</a> <a href="/tags/Fisher/" style="font-size: 14px; color: #999">Fisher</a> <a href="/tags/Http/" style="font-size: 18px; color: #7e7e7e">Http</a> <a href="/tags/HyperLPR/" style="font-size: 14px; color: #999">HyperLPR</a> <a href="/tags/IAR/" style="font-size: 14px; color: #999">IAR</a> <a href="/tags/Java/" style="font-size: 20px; color: #707070">Java</a> <a href="/tags/Keras/" style="font-size: 14px; color: #999">Keras</a> <a href="/tags/MVP/" style="font-size: 14px; color: #999">MVP</a> <a href="/tags/Maven/" style="font-size: 14px; color: #999">Maven</a> <a href="/tags/Mnist/" style="font-size: 18px; color: #7e7e7e">Mnist</a> <a href="/tags/NetSecurity/" style="font-size: 14px; color: #999">NetSecurity</a> <a href="/tags/Omnetpp/" style="font-size: 14px; color: #999">Omnetpp</a> <a href="/tags/OpenCV/" style="font-size: 18px; color: #7e7e7e">OpenCV</a> <a href="/tags/Qt/" style="font-size: 14px; color: #999">Qt</a> <a href="/tags/RFID/" style="font-size: 14px; color: #999">RFID</a> <a href="/tags/STM32/" style="font-size: 14px; color: #999">STM32</a> <a href="/tags/SVM/" style="font-size: 14px; color: #999">SVM</a> <a href="/tags/SharedPreferences/" style="font-size: 14px; color: #999">SharedPreferences</a> <a href="/tags/Spring/" style="font-size: 14px; color: #999">Spring</a> <a href="/tags/TensorFlow/" style="font-size: 14px; color: #999">TensorFlow</a> <a href="/tags/Thread/" style="font-size: 14px; color: #999">Thread</a> <a href="/tags/Ubuntu/" style="font-size: 16px; color: #8b8b8b">Ubuntu</a> <a href="/tags/WSN/" style="font-size: 14px; color: #999">WSN</a> <a href="/tags/Zigbee/" style="font-size: 22px; color: #636363">Zigbee</a> <a href="/tags/c/" style="font-size: 14px; color: #999">c++</a> <a href="/tags/omnetpp/" style="font-size: 16px; color: #8b8b8b">omnetpp</a>
    </div>
  </section>


          
        
      
        
          
          
            


  <section class='widget music'>
    
<header class='pure'>
  <div><i class="fas fa-compact-disc fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;最近在听</div>
  
    <a class="rightBtn"
    
      rel="external nofollow noopener noreferrer"
    
    
      target="_blank"
    
    href="https://c.y.qq.com/base/fcgi-bin/u?__=jsQmg4H"
    title="https://c.y.qq.com/base/fcgi-bin/u?__=jsQmg4H">
    <i class="far fa-heart fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.7.0/dist/APlayer.min.css">
  <div class="aplayer"
    data-theme="#1BCDFC"
    
    
    data-mode="circulation"
    data-server="tencent"
    data-type="playlist"
    data-id="4222498938"
    data-volume="0.7">
  </div>
  <script src="https://cdn.jsdelivr.net/npm/aplayer@1.7.0/dist/APlayer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/meting@1.1.0/dist/Meting.min.js"></script>


    </div>
  </section>


          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
    <div class="footer">
      <p>已经到底了，但是精彩继续！</p>

    </div>
    <br>
  
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="/stefancharles@vip.qq.com"
            class="social fas fa-envelope flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/Stefancharles"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://c.y.qq.com/base/fcgi-bin/u?__=jsQmg4H"
            class="social fas fa-headphones-alt flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>

    
      
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "AIzaSyBjTC6INtmeYy3ig7VaKWeU5obyVnyOAuA";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "007855274890026858194:3gmzbmgvb-q";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('.cover') {
          $('.cover').backstretch(
          ["https://img.vim-cn.com/6d/a0c9e6f9efad8b731cb7376504bd10d79d2053.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://img.vim-cn.com/6d/a0c9e6f9efad8b731cb7376504bd10d79d2053.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        }
      });
    </script>
  









  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
    
      <script src="https://cdn.jsdelivr.net/gh/xaoxuu/volantis@1.0/js/volantis.min.js"></script>
    
  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var guest_info = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var notify = 'true' == true;
  var verify = 'true' == true;
  var valine = new Valine();
  valine.init({
    el: '#valine_container',
    notify: notify,
    verify: verify,
    guest_info: guest_info,
    
    appId: "wlBz3oHtoKBEhnTNtpqYUTGX-gzGzoHsz",
    appKey: "UlbGNoRRKQR1eV0uLcaHwkI1",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'mp',
    lang:'zh-cn',
    highlight:'true'
  })
  </script>



  <script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.5/js/app.js"></script>


  <script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.5/js/search.js"></script>




<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
